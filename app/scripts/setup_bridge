#!/bin/bash

set -e  # Exit on error

CLUSTER=$1
if [[ -z "$CLUSTER" || "$CLUSTER" -lt 1 ]]; then
    echo "Usage: $0 <cluster_number>"
    exit 1
fi

X=$(( (CLUSTER - 1) / 256 + 10 ))
Y=$(( (CLUSTER - 1) % 256 ))

SUBNET="10.$X.$Y.0"
GW="10.$X.$Y.1"
BR="venvbr${CLUSTER}"
DUMMY="dummy${CLUSTER}"
PIDFILE="/tmp/dhcp-$BR/pid"
CONF_DIR="/tmp/dhcp-$BR"

# 1. Create bridge if it doesn't exist
if ! ip link show "$BR" > /dev/null 2>&1; then
    ip link add "$BR" type bridge
    ip addr add "$GW/24" dev "$BR"
    ip link set "$BR" up
fi

# 2. Create dummy interface and attach to bridge
if ! ip link show "$DUMMY" > /dev/null 2>&1; then
    ip link add "$DUMMY" type dummy
    ip link set "$DUMMY" up
    ip link set "$DUMMY" master "$BR"
fi

# 3. Create unique dnsmasq config
mkdir -p "$CONF_DIR"
cat <<EOF > "$CONF_DIR/dnsmasq.conf"
interface=$BR
bind-interfaces
listen-address=$GW
port=0
no-resolv
no-hosts
log-dhcp
dhcp-range=${SUBNET%.*}.100,${SUBNET%.*}.199,12h
dhcp-option=3,$GW
EOF

# 4. Kill old dnsmasq if still alive
if [[ -f "$PIDFILE" ]]; then
    OLD_PID=$(cat "$PIDFILE")
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo "[INFO] Killing previous dnsmasq (PID $OLD_PID) for $BR"
        kill "$OLD_PID"
    fi
    rm -f "$PIDFILE"
fi

# 5. Start dnsmasq only for this bridge
dnsmasq --conf-file="$CONF_DIR/dnsmasq.conf" \
        --pid-file="$PIDFILE" \
        --dhcp-leasefile="$CONF_DIR/leases" \
        --user=root

echo "[OK] Cluster $CLUSTER is ready: $BR ($SUBNET/24)"

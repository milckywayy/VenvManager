{% extends "base.html" %}

{% block title %}Create Cluster{% endblock %}

{% block head_extra %}
<script>
  // --- Utilities ---
  function qs(sel, ctx=document){return ctx.querySelector(sel)}
  function qsa(sel, ctx=document){return Array.from(ctx.querySelectorAll(sel))}

  function getRows(){ return qsa('[data-env-row]') }

  function valueOrEmpty(v){ return (v || '').toString().toLowerCase() }

  function updateSelectionCount(){
    const total = getRows().filter(r => r.style.display !== 'none').length
    const checked = qsa('input[name="environment_ids"]:checked').length
    const totalAll = getRows().length
    const el = qs('#env-selected-count')
    if(el){ el.textContent = `${checked} selected · ${total} visible / ${totalAll} total` }

    const master = qs('#env-master')
    if(master){
      const visibleCheckboxes = getRows()
        .filter(r => r.style.display !== 'none')
        .map(r => r.querySelector('input[type="checkbox"]'))
      const allChecked = visibleCheckboxes.length>0 && visibleCheckboxes.every(cb => cb.checked)
      const someChecked = visibleCheckboxes.some(cb => cb.checked)
      master.checked = allChecked
      master.indeterminate = !allChecked && someChecked
    }
  }

  function toggleSelectAll(){
    const master = qs('#env-master')
    const visible = getRows().filter(r => r.style.display !== 'none')
    visible.forEach(r => {
      const cb = r.querySelector('input[type="checkbox"]')
      if(cb){ cb.checked = master.checked }
    })
    updateSelectionCount()
  }

  function clearSelection(){
    qsa('input[name="environment_ids"]:checked').forEach(cb => cb.checked = false)
    updateSelectionCount()
  }

  function filterEnvs(){
    const q = valueOrEmpty(qs('#env-search')?.value).trim()
    const type = qs('#env-type')?.value || 'all'
    getRows().forEach(r => {
      const text = valueOrEmpty(r.dataset.search)
      const rType = r.dataset.type || 'none'
      const matchText = !q || text.includes(q)
      const matchType = (type==='all') || (type===rType)
      r.style.display = (matchText && matchType) ? '' : 'none'
    })
    updateSelectionCount()
  }

  function sortEnvs(by){
    const tbody = qs('#env-tbody'); if(!tbody) return
    const rows = getRows()
    const dirEl = qs(`#sort-${by}`)
    const dir = (dirEl?.dataset.dir === 'asc') ? 'desc' : 'asc'
    if(dirEl){ dirEl.dataset.dir = dir }

    rows.sort((a,b) => {
      let av='', bv=''
      if(by==='name'){ av=a.dataset.name || ''; bv=b.dataset.name || '' }
      else if(by==='port'){ av=a.dataset.port || ''; bv=b.dataset.port || '' }
      else if(by==='image'){ av=a.dataset.image || ''; bv=b.dataset.image || '' }
      av=av.toLowerCase(); bv=bv.toLowerCase()
      if(av< bv) return dir==='asc' ? -1:1
      if(av> bv) return dir==='asc' ? 1:-1
      return 0
    })

    rows.forEach(r => tbody.appendChild(r))
  }

  document.addEventListener('DOMContentLoaded', () => {
    filterEnvs()
    updateSelectionCount()
    qsa('input[name="environment_ids"]').forEach(cb => cb.addEventListener('change', updateSelectionCount))
    const search = qs('#env-search'); if(search){ search.addEventListener('input', filterEnvs) }
    const type = qs('#env-type'); if(type){ type.addEventListener('change', filterEnvs) }

    getRows().forEach(row => {
    row.addEventListener('click', e => {
      if(e.target.tagName.toLowerCase() === 'input') return

      const cb = row.querySelector('input[type="checkbox"]')
      if(cb){
        cb.checked = !cb.checked
        updateSelectionCount()
      }
    })
  })
  })
</script>
{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-8">
  <h1 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">Create a new cluster</h1>

  {% if message %}
    <div class="mt-4 rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-emerald-900 ring-1 ring-inset ring-emerald-200 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-200 dark:ring-emerald-900/40">
      {{ message }}
    </div>
  {% endif %}
  {% if error %}
    <div class="mt-4 rounded-lg border border-rose-200 bg-rose-50 p-4 text-rose-900 ring-1 ring-inset ring-rose-200 dark:border-rose-900/40 dark:bg-rose-900/20 dark:text-rose-200 dark:ring-rose-900/40">
      {{ error }}
    </div>
  {% endif %}

  <form method="POST" action="{{ url_for('creator.make_cluster') }}"
        class="mt-6 space-y-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900">

    <!-- Cluster name -->
    <div>
      <label for="name" class="mb-1 block text-sm font-medium text-slate-800 dark:text-slate-200">Cluster name</label>
      <input type="text" id="name" name="name" required placeholder="Example: Capture The Flag Task no. 3"
             class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"/>
    </div>

    <!-- Environments -->
    <div>
      <div class="flex flex-wrap items-center justify-between gap-3">
        <label class="block text-sm font-medium text-slate-800 dark:text-slate-200">Environments (select one or more)</label>
        {% if environments and environments|length > 0 %}
          <div class="flex flex-wrap items-center gap-2">
            <div class="relative">
              <input type="text" id="env-search" placeholder="Filter environments…"
                     class="w-64 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"/>
            </div>
            <select id="env-type" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100">
              <option value="all">All types</option>
              <option value="docker">Docker</option>
              <option value="vm">VM</option>
            </select>
            <button type="button" onclick="clearSelection()"
                    class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">Clear selected</button>
          </div>
        {% endif %}
      </div>

      {% if environments and environments|length > 0 %}
        <div class="mt-3 overflow-hidden rounded-xl border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center justify-between gap-3 border-b border-slate-200 px-4 py-2 text-xs text-slate-600 dark:border-slate-800 dark:text-slate-300">
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2"><input id="env-master" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-900" onchange="toggleSelectAll()"/><span>Select all visible</span></label>
              <span id="env-selected-count" class="rounded-full bg-slate-100 px-2.5 py-0.5 text-slate-700 ring-1 ring-inset ring-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:ring-slate-700">0 selected</span>
            </div>
            <div class="flex items-center gap-1">
              Sort by:
              <button id="sort-name" type="button" data-dir="asc" onclick="sortEnvs('name')" class="rounded px-2 py-1 hover:bg-slate-50 dark:hover:bg-slate-800">Name</button>
              <button id="sort-port" type="button" data-dir="asc" onclick="sortEnvs('port')" class="rounded px-2 py-1 hover:bg-slate-50 dark:hover:bg-slate-800">Port</button>
              <button id="sort-image" type="button" data-dir="asc" onclick="sortEnvs('image')" class="rounded px-2 py-1 hover:bg-slate-50 dark:hover:bg-slate-800">Image</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800">
              <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:bg-slate-800/60 dark:text-slate-300">
                <tr>
                  <th class="w-10 px-3 py-3 text-left">Sel</th>
                  <th class="px-3 py-3 text-left">Type</th>
                  <th class="px-3 py-3 text-left">Name</th>
                  <th class="px-3 py-3 text-left">Image</th>
                  <th class="px-3 py-3 text-left">Ports</th>
                </tr>
              </thead>
              <tbody id="env-tbody" class="divide-y divide-slate-200 dark:divide-slate-800">
                {% for env in environments %}
                  {% set _type = env.docker and 'docker' or (env.vm and 'vm' or 'none') %}
                  {% set _image = env.docker and env.docker.image or (env.vm and env.vm.base_image_path or '') %}
                  <tr data-env-row data-type="{{ _type }}" data-name="{{ env.name }}" data-image="{{ _image }}" data-port="{{ env.ports|join(',') if env.ports else '' }}" data-search="{{ (env.name ~ ' ' ~ _image ~ ' ' ~ (env.ports|join(' ') if env.ports else '')) | lower }}" class="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                    <td class="whitespace-nowrap px-3 py-3 align-top">
                      <input type="checkbox" name="environment_ids" value="{{ env.id }}" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-900"/>
                    </td>
                    <td class="whitespace-nowrap px-3 py-3 align-top text-sm">
                      {% if env.docker %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-sky-50 px-2.5 py-0.5 text-xs font-medium text-sky-700 ring-1 ring-inset ring-sky-200 dark:bg-sky-900/20 dark:text-sky-300 dark:ring-sky-800">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 14c0 3.866 3.134 7 7 7h5a6 6 0 006-6v-1H3zM4 13h16v-2H4v2zm5-3h3V7H9v3zm4 0h3V7h-3v3zM8 10H5V7h3v3z"/></svg>
                          Docker
                        </span>
                      {% elif env.vm %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-violet-50 px-2.5 py-0.5 text-xs font-medium text-violet-700 ring-1 ring-inset ring-violet-200 dark:bg-violet-900/20 dark:text-violet-300 dark:ring-violet-800">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5a2 2 0 012-2h12a2 2 0 012 2v9a2 2 0 01-2 2h-5l2 3H9l2-3H6a2 2 0 01-2-2V5z"/></svg>
                          VM
                        </span>
                      {% endif %}
                    </td>
                    <td class="px-3 py-3 align-top text-sm font-medium text-slate-900 dark:text-slate-100">{{ env.name }}</td>
                    <td class="px-3 py-3 align-top text-sm text-slate-700 dark:text-slate-300">
                      {% if env.docker %}
                        <span class="font-mono">{{ env.docker.image }}</span>
                      {% elif env.vm %}
                        <span class="font-mono">{{ env.vm.base_image_path.split('/')[-1] }}</span>
                      {% else %}
                        <span class="text-slate-400 dark:text-slate-500">—</span>
                      {% endif %}
                    </td>
                    <td class="px-3 py-3 align-top text-sm">
                      {% if env.ports %}
                        <ul class="flex flex-wrap gap-2">
                          {% for p in env.ports %}
                            <li class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-inset ring-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:ring-slate-700">{{ p }}</li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <span class="text-slate-400 dark:text-slate-500">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="mt-3 rounded-lg border border-amber-200 bg-amber-50 p-4 text-amber-900 ring-1 ring-inset ring-amber-200 dark:border-amber-900/40 dark:bg-amber-900/20 dark:text-amber-200 dark:ring-amber-900/40">
          No environments found. Create a Docker or VM environment first, then come back here.
        </div>
      {% endif %}
    </div>

    <!-- Submit -->
    <div class="pt-2">
      <button type="submit" {% if not environments or environments|length == 0 %}disabled{% endif %}
              class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-blue-500/30 hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-600/50 active:translate-y-px disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-600 disabled:ring-0 dark:disabled:bg-slate-700 dark:disabled:text-slate-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        Create cluster
      </button>
    </div>
  </form>
</div>
{% endblock %}

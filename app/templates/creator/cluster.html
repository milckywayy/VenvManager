{% extends "base.html" %}

{% block head_extra %}
<style>
    :root {
        --fg:#e5e7eb;
        --muted:#9ca3af;
        --border:#374151;
        --bg:#111827;
        --card-bg:#1e293b;
        --input-bg:#0f172a;
        --ok-bg:#14532d;
        --ok-border:#15803d;
        --error-bg:#7f1d1d;
        --error-border:#b91c1c;
        --warning-bg:#78350f;
        --warning-border:#d97706;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: var(--bg);
        color: var(--fg);
    }

    form { max-width: 700px; }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--fg);
    }

    .env-list {
        border: 1px solid var(--border);
        padding: 10px;
        margin-top: 10px;
        max-height: 320px;
        overflow: auto;
        background: var(--card-bg);
        border-radius: 6px;
    }

    .env-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        border-bottom: 1px dashed var(--border);
    }

    .env-row:last-child { border-bottom: none; }

    .env-row .meta {
        font-size: 12px;
        color: var(--muted);
    }

    .search {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .search input { flex: 1; }

    .warning {
        background: var(--warning-bg);
        border: 1px solid var(--warning-border);
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        color: #fcd34d;
    }

    .ok {
        background: var(--ok-bg);
        border: 1px solid var(--ok-border);
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        color: #bbf7d0;
    }

    .error {
        background: var(--error-bg);
        border: 1px solid var(--error-border);
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        color: #fecaca;
    }

    button[type="submit"] {
        margin-top: 15px;
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: white;
        cursor: pointer;
    }

    button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
<script>
    function filterEnvs() {
        const q = document.getElementById('env-search').value.toLowerCase().trim();
        const rows = document.querySelectorAll('.env-row');
        rows.forEach(r => {
            const txt = r.dataset.searchable;
            r.style.display = txt.includes(q) ? '' : 'none';
        });
    }
</script>
{% endblock %}

{% block content %}

<h1>Create a new cluster</h1>

{% if message %}
  <div class="ok">{{ message }}</div>
{% endif %}
{% if error %}
  <div class="error">{{ error }}</div>
{% endif %}

<form method="POST" action="{{ url_for('creator.make_cluster') }}">
    <label for="name">Cluster name</label>
    <input type="text" id="name" name="name" required>

    <label>Environments (select one or more)</label>
    {% if environments and environments|length > 0 %}
        <div class="search">
            <input type="text" id="env-search" placeholder="Filter environments..." oninput="filterEnvs()">
        </div>
        <div class="env-list">
            {% for env in environments %}
                <div class="env-row" data-searchable="{{ (env.name ~ ' ' ~ (env.docker.image if env.docker else '') ~ ' ' ~ (env.vm.base_image_path if env.vm else '')) | lower }}">
                    <input type="checkbox" id="env-{{ env.id }}" name="environment_ids" value="{{ env.id }}">
                    <label for="env-{{ env.id }}">
                        <strong>{{ env.name }}</strong>
                        <div class="meta">
                            {% if env.docker %}
                                Docker: {{ env.docker.image }}
                            {% elif env.vm %}
                                VM: {{ env.vm.base_image_path }}
                            {% else %}
                                (no backend attached)
                            {% endif %}
                            {% if env.ports and env.ports|length > 0 %}
                                Â· Ports: {{ env.ports | list }}
                            {% endif %}
                        </div>
                    </label>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="warning">No environments found. Create a Docker or VM environment first, then come back here.</div>
    {% endif %}

    <button type="submit" {% if not environments or environments|length == 0 %}disabled{% endif %}>Create cluster</button>
</form>

{% endblock %}

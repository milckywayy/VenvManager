{% extends "base.html" %}

{% block title %}Create Environment{% endblock %}

{% block banner_right %}
  <a id="backBtn"
     href="{{ url_for('main.environments') }}"
     class="inline-flex items-center gap-2 rounded-md border border-gray-200 dark:border-gray-700
            bg-white dark:bg-gray-900 px-3 py-2 text-sm font-medium
            text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800
            focus:outline-none focus:ring-2 focus:ring-blue-500"
     aria-label="Wróć do poprzedniej strony"
     title="Wróć (Alt + ←)">
    <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h20"/>
    </svg>
    <span>Back</span>
  </a>
{% endblock %}

{% block head_extra %}
<style>
  /* Optional: narrow number inputs on iOS */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }
</style>

<script>
  function addPortRow() {
    const container = document.getElementById('ports-container');
    const row = document.createElement('div');
    row.className = "flex items-center gap-3";
    row.innerHTML = `
      <div class="flex-1">
        <input type="number" name="ports" placeholder="Internal port (1–65535)"
               min="1" max="65535" required
               class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:placeholder-slate-500"/>
      </div>
      <button type="button" onclick="removePortRow(this)"
        class="inline-flex items-center gap-1.5 rounded-lg bg-white px-2.5 py-2 text-sm font-medium text-slate-700
                 border border-slate-300 shadow-sm
                 hover:border-red-500 hover:text-red-600
                 focus:outline-none focus:ring-2 focus:ring-red-400/60
                 dark:bg-slate-900 dark:text-slate-300 dark:border-slate-600 dark:hover:border-red-400 dark:hover:text-red-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2h.293l.853 10.24A2 2 0 007.138 18h5.724a2 2 0 001.992-1.76L15.707 6H16a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM8 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/>
        </svg>
        Remove
      </button>
    `;
    container.appendChild(row);
  }

  function removePortRow(button) {
    const container = document.getElementById('ports-container');
    if (container.children.length > 1) {
      button.closest('div').remove();
    } else {
      alert("At least one port must be defined.");
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    addPortRow();
  });
</script>
{% endblock %}

{% block content %}

<div class="mx-auto max-w-6xl px-4 py-8">
  <h1 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">Create VM Environment</h1>

  <form method="POST" action="{{ url_for('creator.make_vm') }}"
        class="mt-6 space-y-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900">

    <!-- Environment name -->
    <div>
      <label for="name" class="mb-1 block text-sm font-medium text-slate-800 dark:text-slate-200">
        Environment name
      </label>
      <input type="text" id="name" name="name" required
             placeholder="Example: Ubuntu VM with Nginx"
             class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"/>
    </div>

    <!-- Libvirt image -->
    <div>
      <label for="base_image_path" class="mb-1 block text-sm font-medium text-slate-800 dark:text-slate-200">
        Libvirt image
      </label>

      {% if images and images|length > 0 %}
        <select id="base_image_path" name="base_image_path" required
                class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100">
          <option value="" disabled selected>-- Select an image --</option>
          {% for name, path in images.items() %}
            <option value="{{ path|e }}">{{ name|e }}</option>
          {% endfor %}
        </select>
        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Choose the backing image file for this VM.</p>
      {% else %}
        <div class="rounded-lg border border-amber-200 bg-amber-50 p-4 text-amber-900 ring-1 ring-inset ring-amber-200 dark:border-amber-900/40 dark:bg-amber-900/20 dark:text-amber-200 dark:ring-amber-900/40">
          <div class="flex items-start gap-3">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full ring-1 ring-inset ring-amber-200 dark:ring-amber-900/50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.518 11.586c.75 1.334-.213 3.015-1.743 3.015H3.482c-1.53 0-2.493-1.68-1.743-3.015L8.257 3.1zM11 14a1 1 0 11-2 0 1 1 0 012 0zm-1-2a1 1 0 01-1-1V7a1 1 0 112 0v4a1 1 0 01-1 1z" clip-rule="evenodd"/>
              </svg>
            </span>
            <div class="text-sm">
              No images were found.
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- VM Template -->
    <div>
      <div class="flex items-center justify-between">
        <label for="template" class="mb-1 block text-sm font-medium text-slate-800 dark:text-slate-200">
          Template
        </label>
      </div>
      <textarea id="template" name="template" rows="6"
                placeholder="Libvirt domain XML…"
                style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space: pre;"
                class="mt-2 block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"></textarea>
      <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Paste your VM definition.</p>
    </div>

    <!-- Ports -->
    <div>
      <div class="flex items-center justify-between">
        <label class="block text-sm font-medium text-slate-800 dark:text-slate-200">Ports</label>
        <button type="button" onclick="addPortRow()"
                class="inline-flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-sm font-medium text-slate-700
                         border border-slate-300 shadow-sm
                         hover:border-blue-500 hover:text-blue-600
                         focus:outline-none focus:ring-2 focus:ring-blue-400/60
                         dark:bg-slate-900 dark:text-slate-200 dark:border-slate-600
                         dark:hover:border-blue-400 dark:hover:text-blue-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" d="M12 5v14M5 12h14"/>
          </svg>
          Add port
        </button>
      </div>
      <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Specify internal ports to expose from the VM.</p>
      <div id="ports-container" class="mt-3 space-y-2"></div>
    </div>

    <!-- Access Info -->
    <div>
      <label for="access_info" class="mb-2 block text-sm font-medium text-slate-800 dark:text-slate-200">
        Access Info
      </label>
      <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Enter access details. Use the internal ports you defined above. e.g. {{ '{{port}}' }}.</p>
      <textarea id="access_info" name="access_info" required rows="3"
                placeholder="Conect using RDP: localhost:{{ '{{3389}}' }}
username: milckywayy, password: 1234"
                class="block w-full rounded-lg border border-slate-300 bg-white mt-3 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"></textarea>
    </div>

    <!-- Submit -->
    <div class="pt-2">
      <button type="submit"
        class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-blue-500/30 hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-600/50 active:translate-y-px">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          Create environment
      </button>
    </div>
  </form>
</div>

{% endblock %}

{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head_extra %}
  <style>
    .meter { @apply h-2 w-full rounded bg-gray-200 dark:bg-gray-800 overflow-hidden; }
    .meter > span { @apply block h-full rounded; background: linear-gradient(90deg, rgb(59 130 246), rgb(34 197 94)); }

    .shimmer { position: relative; overflow: hidden; }
    .shimmer::after {
      content:""; position:absolute; inset:0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    .skeleton {
      @apply bg-gray-200 dark:bg-gray-700 rounded;
      position: relative;
      overflow: hidden;
      color: transparent !important;
    }
    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      animation: shimmer 1.5s infinite;
    }
    .sk-text { @apply h-4 inline-block align-middle; min-width: 6ch; }
    .sk-text.sm { @apply h-3; min-width: 4ch; }
  </style>
{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-8">
  <header class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-gray-900 dark:text-gray-100">
        VenvManager Overview
      </h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        <span id="lastUpdated" class="sk-text skeleton">—</span>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <button id="refreshBtn"
        class="rounded-md border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800">
        Refresh
      </button>
    </div>
  </header>

  <div class="grid gap-6 md:grid-cols-2">
    <section class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900 p-5">
      <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Host</h2>
      <div class="space-y-4">
        <div>
          <div class="mb-1 flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-300">CPU usage</span>
            <span id="hostCpuLabel" class="text-sm font-medium text-gray-900 dark:text-gray-100 sk-text skeleton">—</span>
          </div>
          <div class="meter"><span id="hostCpuBar" class="skeleton" style="width:100%"></span></div>
        </div>

        <div>
          <div class="mb-1 flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-300">Memory usage</span>
            <span id="hostMemLabel" class="text-sm font-medium text-gray-900 dark:text-gray-100 sk-text skeleton">—</span>
          </div>
          <div class="meter"><span id="hostMemBar" class="skeleton" style="width:100%"></span></div>
          <p id="hostMemTotal" class="mt-1 text-xs text-gray-500 dark:text-gray-400 sk-text sm skeleton">—</p>
        </div>

        <div class="grid gap-3 sm:grid-cols-2">
          <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-3">
            <div class="text-xs text-gray-500 dark:text-gray-400">Network – RX</div>
            <div id="hostRx" class="text-sm font-semibold text-gray-900 dark:text-gray-100 sk-text skeleton">—</div>
          </div>
          <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-3">
            <div class="text-xs text-gray-500 dark:text-gray-400">Network – TX</div>
            <div id="hostTx" class="text-sm font-semibold text-gray-900 dark:text-gray-100 sk-text skeleton">—</div>
          </div>
        </div>
      </div>
    </section>

    <section class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900 p-5">
      <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Clusters</h2>
      <div class="space-y-4">
        <div>
          <div class="mb-1 flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-300">Running clusters</span>
            <span id="clustersCountLabel" class="text-sm font-medium text-gray-900 dark:text-gray-100 sk-text skeleton">—</span>
          </div>
          <div class="meter"><span id="clustersCountBar" class="skeleton" style="width:100%"></span></div>
        </div>

        <div>
          <div class="mb-1 flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-300">Memory (MB)</span>
            <span id="overallMemLabel" class="text-sm font-medium text-gray-900 dark:text-gray-100 sk-text skeleton">—</span>
          </div>
          <div class="meter"><span id="overallMemBar" class="skeleton" style="width:100%"></span></div>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 sk-text sm">Clusters summary usage</p>
        </div>

        <div class="grid gap-3 sm:grid-cols-2">
          <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-3">
            <div class="text-xs text-gray-500 dark:text-gray-400">Network – RX</div>
            <div id="overallRx" class="text-sm font-semibold text-gray-900 dark:text-gray-100 sk-text skeleton">—</div>
          </div>
          <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-3">
            <div class="text-xs text-gray-500 dark:text-gray-400">Network – TX</div>
            <div id="overallTx" class="text-sm font-semibold text-gray-900 dark:text-gray-100 sk-text skeleton">—</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <section class="mt-8">
    <div class="mb-3 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Running Clusters</h2>
      <input id="clusterSearch" type="search" placeholder="Search by name or ID…"
             class="w-72 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div class="overflow-hidden rounded-xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
        <thead class="bg-slate-50 dark:bg-slate-800/60">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Session ID</th>
            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Cluster Name</th>
            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Cluster ID</th>
            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Time left</th>
            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Memory</th>
            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Network RX / TX</th>
          </tr>
        </thead>
        <tbody id="clustersBody" class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900 p-5">
          <tr class="shimmer"><td class="px-4 py-6 text-sm text-gray-400" colspan="5"></td></tr>
          <tr class="shimmer"><td class="px-4 py-6 text-sm text-gray-400" colspan="5"></td></tr>
          <tr class="shimmer"><td class="px-4 py-6 text-sm text-gray-400" colspan="5"></td></tr>
        </tbody>
      </table>
    </div>

    <div id="clustersEmpty" class="hidden rounded-lg border border-dashed border-gray-300 dark:border-gray-700 p-8 text-center text-gray-500 dark:text-gray-400">
      No clusters to display.
    </div>
  </section>
</div>

<script>
  const fmt = {
    percent: v => (v == null ? "—" : `${v.toFixed(0)}%`),
    mib: v => (v == null ? "—" : `${(Number(v)/1024/1024).toFixed(1)} MiB`),
    bytes: v => {
      if (v == null) return "—";
      const units = ["B","KB","MB","GB","TB","PB"];
      let n = Number(v), i = 0;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(n < 10 ? 2 : n < 100 ? 1 : 0)} ${units[i]}`;
    },
    ts: () => new Date().toLocaleString(),
  };

  let hasShownSkeleton = false;
  let inFlight = false;

  const els = {
    lastUpdated: document.getElementById("lastUpdated"),

    hostCpuLabel: document.getElementById("hostCpuLabel"),
    hostCpuBar: document.getElementById("hostCpuBar"),
    hostMemLabel: document.getElementById("hostMemLabel"),
    hostMemBar: document.getElementById("hostMemBar"),
    hostMemTotal: document.getElementById("hostMemTotal"),
    hostRx: document.getElementById("hostRx"),
    hostTx: document.getElementById("hostTx"),

    clustersCountLabel: document.getElementById("clustersCountLabel"),
    clustersCountBar: document.getElementById("clustersCountBar"),
    overallMemLabel: document.getElementById("overallMemLabel"),
    overallMemBar: document.getElementById("overallMemBar"),
    overallRx: document.getElementById("overallRx"),
    overallTx: document.getElementById("overallTx"),

    clustersBody: document.getElementById("clustersBody"),
    clustersEmpty: document.getElementById("clustersEmpty"),
    search: document.getElementById("clusterSearch"),
    refreshBtn: document.getElementById("refreshBtn"),
  };

  function setBar(el, pct) {
    el.style.width = `${Math.max(0, Math.min(100, pct || 0))}%`;
  }

  function showSkeleton(...nodes) {
    for (const el of nodes) {
      if (!el) continue;
      el.classList.add("skeleton");
      if (el.tagName && (el.tagName === 'SPAN' || el.tagName === 'DIV' || el.tagName === 'P')) {
        el.textContent = "—";
      }
    }
  }
  function hideSkeleton(...nodes) {
    for (const el of nodes) {
      if (!el) continue;
      el.classList.remove("skeleton");
    }
  }
  function showBarSkeleton(...bars) {
    for (const el of bars) {
      if (!el) continue;
      el.classList.add("skeleton");
      el.style.width = "100%";
    }
  }
  function hideBarSkeleton(...bars) {
    for (const el of bars) {
      if (!el) continue;
      el.classList.remove("skeleton");
    }
  }

  function rowCluster(c) {
    const res = c.resources || {};
    const mem = Number(res.memory) || 0;
    const net = res.network || {};
    const rx = Number(net.rx) || 0;
    const tx = Number(net.tx) || 0;

    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50";
    tr.innerHTML = `
      <td class="px-4 py-3 text-left">
        <div class="font-mono text-base font-semibold text-gray-900 dark:text-gray-100">
          ${escapeHtml(c.session_id || "—")}
        </div>
      </td>

      <td class="px-4 py-3 text-center">
        <div class="text-sm font-medium font-semibold text-gray-900 dark:text-gray-100">
          ${escapeHtml(c.cluster_name || "(no name)")}
        </div>
      </td>

      <td class="px-4 py-3 text-center">
        <div class="text-xs text-gray-600 dark:text-gray-300">
          ${escapeHtml(c.cluster_id || "—")}
        </div>
      </td>

      <td class="px-4 py-3 text-center">
        <div class="text-xs text-gray-600 dark:text-gray-300">
          ${escapeHtml(c.ttl_remaining_seconds || "—")}
          s
        </div>
      </td>

      <td class="px-4 py-3 text-center">
        <div class="text-xs text-gray-600 dark:text-gray-300">
          ${fmt.mib(mem)}
        </div>
      </td>

      <td class="px-4 py-3 text-right">
        <div class="text-xs text-gray-600 dark:text-gray-300">
          ${fmt.bytes(rx)} <span class="text-gray-400">/</span> ${fmt.bytes(tx)}
        </div>
      </td>
    `;
    return tr;
  }


  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function filterRows() {
    const q = (els.search.value || "").toLowerCase();
    for (const tr of els.clustersBody.querySelectorAll("tr")) {
      const text = tr.innerText.toLowerCase();
      tr.style.display = text.includes(q) ? "" : "none";
    }
    const anyVisible = Array.from(els.clustersBody.querySelectorAll("tr")).some(tr => tr.style.display !== "none");
    els.clustersEmpty.classList.toggle("hidden", anyVisible);
  }

  async function loadData({ showBusy = false } = {}) {
    if (inFlight) return;
    inFlight = true;

    try {
      if (showBusy) {
        els.refreshBtn.disabled = true;
        els.refreshBtn.classList.add("opacity-50","cursor-wait");
      }

      if (!hasShownSkeleton) {
        showSkeleton(
          els.lastUpdated,
          els.hostCpuLabel, els.hostMemLabel, els.hostMemTotal,
          els.hostRx, els.hostTx,
          els.overallMemLabel, els.overallRx, els.overallTx
        );
        showBarSkeleton(els.hostCpuBar, els.hostMemBar, els.clustersCountBar, els.overallMemBar);
      }

      const resp = await fetch("{{ get_api_url('resources/summary') }}", { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      const h = data.host || {};
      const hCpu = Number(h.cpu_percent) || 0;
      els.hostCpuLabel.textContent = fmt.percent(hCpu);
      setBar(els.hostCpuBar, hCpu);

      els.hostMemLabel.textContent = fmt.percent(Number(h.memory_percent) || 0);
      setBar(els.hostMemBar, Number(h.memory_percent) || 0);
      els.hostMemTotal.textContent = `Total: ${fmt.bytes(h.memory_total)}`;

      const hnet = h.network || {};
      els.hostRx.textContent = fmt.bytes(hnet.rx);
      els.hostTx.textContent = fmt.bytes(hnet.tx);

      const o = data.overall || {};
      const omem = Number(o.memory) || 0;
      els.overallMemLabel.textContent = `${(omem/1024/1024).toFixed(1)} MiB`;

      const scaleMem = Math.max(omem, Number(h.memory_total || 0));
      const rel = scaleMem ? (omem / scaleMem) * 100 : 0;
      setBar(els.overallMemBar, rel);

      const onet = o.network || {};
      els.overallRx.textContent = fmt.bytes(onet.rx);
      els.overallTx.textContent = fmt.bytes(onet.tx);

      const list = Array.isArray(data.clusters) ? data.clusters : [];
      const clusterCount = list.length;
      els.clustersCountLabel.textContent = clusterCount.toString();
      els.clustersCountLabel.classList.remove("skeleton");

      els.clustersBody.innerHTML = "";
      if (list.length === 0) {
        els.clustersEmpty.classList.remove("hidden");
      } else {
        els.clustersEmpty.classList.add("hidden");
        for (const c of list) els.clustersBody.appendChild(rowCluster(c));
      }
      filterRows();

      els.lastUpdated.textContent = `last update: ${fmt.ts()}`;

      if (!hasShownSkeleton) {
        hideSkeleton(
          els.lastUpdated,
          els.hostCpuLabel, els.hostMemLabel, els.hostMemTotal,
          els.hostRx, els.hostTx,
          els.overallMemLabel, els.overallRx, els.overallTx
        );
        hideBarSkeleton(els.hostCpuBar, els.hostMemBar, els.clustersCountBar, els.overallMemBar);
        hasShownSkeleton = true;
      }

    } catch (e) {
      console.error(e);
      els.lastUpdated.textContent = "błąd pobierania danych";
      hideSkeleton(els.lastUpdated);
      els.clustersBody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-6 text-sm text-red-600 dark:text-red-400">
            Nie udało się pobrać danych z <code class="font-mono">/api/resources/summary</code>.
          </td>
        </tr>`;
      els.clustersEmpty.classList.add("hidden");

      hideBarSkeleton(els.hostCpuBar, els.hostMemBar, els.overallMemBar, els.clustersCountBar);
      hideSkeleton(
        els.hostCpuLabel, els.hostMemLabel, els.hostMemTotal,
        els.hostRx, els.hostTx,
        els.overallMemLabel, els.overallRx, els.overallTx
      );
      hasShownSkeleton = true;

    } finally {
      if (showBusy) {
        els.refreshBtn.disabled = false;
        els.refreshBtn.classList.remove("opacity-50","cursor-wait");
      }
      inFlight = false;
    }
  }

  els.refreshBtn.addEventListener("click", () => loadData({ showBusy: true }));
  els.search.addEventListener("input", filterRows);

  setInterval(loadData, 5000);
  loadData();
</script>
{% endblock %}

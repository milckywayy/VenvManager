{% extends "base.html" %}

{% block head_extra %}
{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-8">

  <!-- Header -->
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">VenvManager Overview</h1>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
        Live metrics &amp; running clusters
        <span id="last-updated" class="ml-2 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-300">
          updating…
        </span>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <button id="refresh-btn" class="inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
        </svg>
        Refresh
      </button>
      <span id="clusters-count-pill" class="hidden items-center rounded-full bg-emerald-50 px-3 py-1 text-sm font-medium text-emerald-700 ring-1 ring-inset ring-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-300 dark:ring-emerald-800">
        0 running
      </span>
    </div>
  </div>

  <!-- Section: Resource Usage -->
  <div class="mb-10">
    <div class="mb-6 flex items-end justify-between gap-4">
      <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Resource Usage</h2>
    </div>

    {% if resources|length == 0 %}
      <div class="rounded-xl border border-slate-200 bg-white p-10 text-center shadow-sm dark:border-slate-800 dark:bg-slate-900">
        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">No data</h3>
        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">No resource usage information available yet.</p>
      </div>
    {% else %}
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <!-- CPU -->
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">CPU</span>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300">{{ resources.cpu }}%</span>
          </div>
          <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-800">
            <div class="h-full rounded-full bg-emerald-500" style="width: {{ resources.cpu }}%"></div>
          </div>
        </div>
        <!-- RAM -->
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">RAM</span>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300">{{ resources.ram }} MB</span>
          </div>
          <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-800">
            <div class="h-full rounded-full bg-indigo-500" style="width: {{ (resources.ram_percent or 0) }}%"></div>
          </div>
          {% if resources.ram_total %}
            <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">of {{ resources.ram_total }} MB</div>
          {% endif %}
        </div>
        <!-- Disk -->
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">Disk</span>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300">{{ resources.disk }} GB</span>
          </div>
          <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-800">
            <div class="h-full rounded-full bg-amber-500" style="width: {{ (resources.disk_percent or 0) }}%"></div>
          </div>
          {% if resources.disk_total %}
            <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">of {{ resources.disk_total }} GB</div>
          {% endif %}
        </div>
        <!-- GPU -->
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">GPU</span>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300">
              {{ resources.gpu_util or '—' }}{% if resources.gpu_util %}%{% endif %}
            </span>
          </div>
          <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-800">
            <div class="h-full rounded-full bg-fuchsia-500" style="width: {{ (resources.gpu_util or 0) }}%"></div>
          </div>
          {% if resources.gpu_name %}
            <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">{{ resources.gpu_name }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Section: Running Clusters -->
  <div>
    <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Running Clusters</h2>

      <div class="flex items-center gap-2">
        <div class="relative">
          <input id="filter-input" type="text" placeholder="Filter by name or ID..."
                 class="w-64 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-indigo-400 dark:focus:ring-indigo-900/40">
          <svg xmlns="http://www.w3.org/2000/svg" class="pointer-events-none absolute right-2 top-2.5 h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
        </div>
      </div>
    </div>

    <!-- Error banner -->
    <div id="error-banner" class="mb-3 hidden rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 dark:border-rose-900/50 dark:bg-rose-900/20 dark:text-rose-300">
      Failed to fetch clusters. Retrying…
    </div>

    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900">
      <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800">
        <thead class="bg-slate-50 dark:bg-slate-800/60">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Session ID</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Cluster Name</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Cluster ID</th>
          </tr>
        </thead>
        <tbody id="clusters-tbody" class="divide-y divide-slate-200 dark:divide-slate-800">
          <!-- Skeleton rows -->
          <tr class="animate-pulse" aria-hidden="true">
            <td class="px-4 py-3"><div class="h-4 w-40 rounded bg-slate-100 dark:bg-slate-800"></div></td>
            <td class="px-4 py-3"><div class="h-4 w-32 rounded bg-slate-100 dark:bg-slate-800"></div></td>
            <td class="px-4 py-3"><div class="h-4 w-48 rounded bg-slate-100 dark:bg-slate-800"></div></td>
            <td class="px-4 py-3"><div class="h-6 w-20 rounded-full bg-slate-100 dark:bg-slate-800"></div></td>
            <td class="px-4 py-3"><div class="h-8 w-16 rounded-lg bg-slate-100 dark:bg-slate-800"></div></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="mt-4 hidden rounded-xl border border-slate-200 bg-white p-10 text-center shadow-sm dark:border-slate-800 dark:bg-slate-900">
      <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">No running clusters</h3>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Start your first cluster to see it listed here.</p>
    </div>
  </div>
</div>

<script>
const API_URL = "{{ url_for('api.running_clusters') }}";

const tbody = document.getElementById("clusters-tbody");
const emptyState = document.getElementById("empty-state");
const errorBanner = document.getElementById("error-banner");
const lastUpdated = document.getElementById("last-updated");
const countPill = document.getElementById("clusters-count-pill");
const filterInput = document.getElementById("filter-input");
const refreshBtn = document.getElementById("refresh-btn");

let allClusters = [];

function fmtTime(d) {
  const pad = (n)=> String(n).padStart(2,'0');
  return `${d.getHours()}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function renderRows(rows) {
  tbody.innerHTML = '';
  rows.forEach(cluster => {
    const session = cluster.session_id || '—';
    const name = cluster.cluster_name || '—';
    const cid = cluster.cluster_id || '—';
    tbody.insertAdjacentHTML('beforeend', `
      <tr class="hover:bg-slate-50/60 dark:hover:bg-slate-800/30">
        <td class="px-4 py-3 text-sm font-mono">${session}</td>
        <td class="px-4 py-3 text-sm">${name}</td>
        <td class="px-4 py-3 text-sm font-mono">${cid}</td>
      </tr>
    `);
  });

  // wire copy buttons
  tbody.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const val = btn.getAttribute('data-copy');
      try {
        await navigator.clipboard.writeText(val);
        btn.innerHTML = 'Copied!';
        setTimeout(() => (btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>Copy`), 1000);
      } catch (e) { /* noop */ }
    });
  });
}

function applyFilters() {
  const q = (filterInput.value || '').toLowerCase().trim();
  let rows = allClusters.slice();

  if (q) {
    rows = rows.filter(c =>
      String(c.cluster_name || '').toLowerCase().includes(q) ||
      String(c.cluster_id || '').toLowerCase().includes(q) ||
      String(c.session_id || '').toLowerCase().includes(q)
    );
  }

  renderRows(rows);
  emptyState.classList.toggle('hidden', rows.length !== 0);
}

function updateKPIs(data) {
  const running = data.length;

  countPill.textContent = `${running} running`;
  countPill.classList.toggle('hidden', false);
}

async function loadClusters({silent=false} = {}) {
  try {
    if (!silent) {
      // show skeleton row while loading
      tbody.innerHTML = `
        <tr class="animate-pulse" aria-hidden="true">
          <td class="px-4 py-3"><div class="h-4 w-40 rounded bg-slate-100 dark:bg-slate-800"></div></td>
          <td class="px-4 py-3"><div class="h-4 w-32 rounded bg-slate-100 dark:bg-slate-800"></div></td>
          <td class="px-4 py-3"><div class="h-4 w-48 rounded bg-slate-100 dark:bg-slate-800"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-20 rounded-full bg-slate-100 dark:bg-slate-800"></div></td>
          <td class="px-4 py-3"><div class="h-8 w-16 rounded-lg bg-slate-100 dark:bg-slate-800"></div></td>
        </tr>`;
    }
    errorBanner.classList.add('hidden');

    const response = await fetch(API_URL, { headers: { 'Accept': 'application/json' }});
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();

    allClusters = Array.isArray(data) ? data : [];
    updateKPIs(allClusters);
    applyFilters();

    const now = new Date();
    lastUpdated.textContent = `updated ${fmtTime(now)}`;
  } catch (err) {
    console.error("Error loading clusters:", err);
    errorBanner.classList.remove('hidden');
    if (!allClusters.length) {
      tbody.innerHTML = '';
      emptyState.classList.toggle('hidden', false);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadClusters();
  setInterval(() => loadClusters({silent: true}), 5000);

  filterInput.addEventListener('input', applyFilters);
  refreshBtn.addEventListener('click', () => loadClusters());
});
</script>
{% endblock %}
